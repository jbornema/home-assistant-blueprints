blueprint:
  name: Heizkreis an/aus
  description: Shelly 1 with addon temperature sensor and classic thermostat as input
  domain: automation
  input:
    shelly_switch:
      name: Shelly
      description: Shelly with temperature sensor
      selector:
        entity:
          domain: switch

    shelly_temp:
        name: Temperature
        description: A sensor that measures the temperature of the room
        selector:
          entity:
            domain: sensor
            device_class: temperature
            
    shelly_input:
        name: Thermostat
        description: Thermostat connected to shelly input
        selector:
          entity:
            domain: binary_sensor
            device_class: power

    min_temp:
        name: Min. Temperature
        description: If > 0 ignore manual thermostat and regulate to this temperature
        default: 0
        selector:
          entity:
            domain: input_number
            
variables:
  shelly_switch: !input shelly_switch
  shelly_temp: !input shelly_temp
  shelly_input: !input shelly_input
  min_temp: !input min_temp

trigger:
  - platform: time_pattern
    minutes: /1

action:
  - choose:
# Turn on
    - conditions:
      - condition: device
        type: is_off
        device_id: '{{ device_id(shelly_switch) }}'
        entity_id: !input shelly_switch
        domain: switch
      - condition: state
        entity_id: input_boolean.alle_thermostate_aktiv
        state: 'on'
      - condition: or
        conditions:
          - condition: numeric_state
            entity_id: !input shelly_temp
            below: input_number.min_temperatur
          - condition: and
            conditions:
              - condition: numeric_state
                entity_id: !input shelly_temp
                below: input_number.max_temperatur
              - type: is_powered
                condition: device
                device_id: '{{ device_id(shelly_input) }}'
                entity_id: !input shelly_input
                domain: binary_sensor
              - "{{ (states(min_temp) | int) == 0 }}"
          - "{{ (states(shelly_temp) | int) < (states(min_temp) | int) }}"
      sequence:
        - service: switch.turn_on
          entity_id: !input shelly_switch
# Turn off
    - conditions:
      - condition: device
        type: is_on
        device_id: '{{ device_id(shelly_switch) }}'
        entity_id: !input shelly_switch
        domain: switch
      - condition: state
        entity_id: input_boolean.alle_thermostate_aktiv
        state: 'on'
      - condition: or
        conditions:
          - condition: numeric_state
            entity_id: !input shelly_temp
            above: input_number.max_temperatur
          - condition: and
            conditions:
              - condition: numeric_state
                entity_id: !input shelly_temp
                above: input_number.min_temperatur
              - type: is_not_powered
                condition: device
                device_id: '{{ device_id(shelly_input) }}'
                entity_id: !input shelly_input
                domain: binary_sensor
              - "{{ (states(min_temp) | int) == 0 }}"
          - "{{ (states(shelly_temp) | int) > (states(min_temp) | int) }}"
      sequence:
        - service: switch.turn_off
          entity_id: !input shelly_switch
